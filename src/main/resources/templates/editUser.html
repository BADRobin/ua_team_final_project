<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit User page</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet"
          href="/css/flatpickr.min.css">
    <script src="/js/flatpickr"></script>
</head>
<body>
    <h1>Edit User page</h1>
    <form action="/edituser" method="post" id="userForm">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}">
        <input type="hidden" name="id" th:value="${user.getUserId()}">
        <table>
            <tr>
                <td><h5>ID</h5></td>
                <td><h5 th:text="${user.getUserId()}"></h5></td>
            </tr>
            <tr>
                <td><h5><label for="name">Name</label></h5></td>
                <td><input type="text" name="name" id="name" th:value="${user.getName()}" class="form-control"></td>
            </tr>
            <tr>
                <td><h5><label for="depts"></label>Department</h5></td>
                <td>
                    <select name="department" id="depts">
                        <option
                                th:each="dept : ${departments}"
                                th:value="${dept.getName()}"
                                th:text="${dept.getName()}"
                                th:selected="${dept.getName.equals(user.getDepartment().getName())}">
                        </option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><h5><label for="roles"></label>Role</h5></td>
                <td>
                    <select name="role" id="roles">
                        <option
                                th:each="role : ${roles}"
                                th:value="${role.getName()}"
                                th:text="${role.getName()}"
                                th:selected="${role.getName.equals(user.getRole().getName())}">
                        </option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><h5><label for="login">Login</label></h5></td>
                <td><input type="text" name="login" id="login" th:value="${user.getLogin()}" class="form-control"></td>
            </tr>
            <tr>
                <td><h5><label for="phone">Phone</label></h5></td>
                <td><input type="text" name="phone" id="phone" th:value="${user.getPhone()}" class="form-control"></td>
            </tr>
            <tr>
                <td><h5><label for="email">Email</label></h5></td>
                <td><input type="text" name="email" id="email" th:value="${user.getEmail()}" class="form-control"></td>
            </tr>
            <tr>
                <td>
                    <h5><label for="datepicker">Hired at</label></h5>
                </td>
                <td>
                    <input type="text" id="datepicker" class="form-control"
                           th:value="${#temporals.format(user.createdAt, 'yyyy-MM-dd')}"/>
                </td>
            </tr>
        </table>
        <button type="submit" id="saveBtn" class="btn btn-primary mt-3" disabled>Save changes</button>
        <button type="button" class="btn btn-danger mt-3" id="deleteBtn">Delete</button>
    </form>
    <form action="/">
        <button>Discard changes</button>
    </form>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            flatpickr("#datepicker", {
                dateFormat: "Y-m-d",
                enableTime: false,
                locale: "en"
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("userForm");
            const saveBtn = document.getElementById("saveBtn");
            const deleteBtn = document.getElementById("deleteBtn");
            const initialData = new FormData(form);

            function checkChanges() {
                const currentData = new FormData(form);
                let isChanged = false;

                for (let key of currentData.keys()) {
                    if (currentData.get(key) !== initialData.get(key)) {
                        isChanged = true;
                        break;
                    }
                }

                saveBtn.disabled = !isChanged;
            }

            form.querySelectorAll("input, select").forEach(element => {
                element.addEventListener("input", checkChanges);
                element.addEventListener("change", checkChanges);
            });

            deleteBtn.addEventListener("click", function () {
                const userId = document.querySelector("input[name='id']").value;
                if (confirm("Are you sure you want to delete this user?")) {
                    window.location.href = "/deleteuser/" + userId;
                }
            });
        });
    </script>
</body>
</html>